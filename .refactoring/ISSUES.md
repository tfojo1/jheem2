# Issues and Tech Debt

**Last Updated:** 2024-11-20
**Session:** Phase 1, Week 1 - Integration

---

## Issues Encountered During Integration

### Issue 1: C++ Build Artifacts Corruption ✅ RESOLVED

**Symptom:**
```
ld: multiple errors: unknown file type in 'engine_helpers.o'
clang++: error: linker command failed with exit code 1
```

**Root Cause:**
Stale `.o` files from previous builds when jheem2 included array_helpers.cpp and ontology_mappings.cpp. After removing those files, the build system tried to link against incompatible object files.

**Solution:**
- Cleaned build artifacts: `rm src/*.o`
- Added to .gitignore: `src/*.o`, `src/*.so`

**Status:** ✅ Resolved
**Priority:** N/A (fixed)
**Tech Debt:** None

---

### Issue 2: Top-Level Code Execution During Package Load ✅ RESOLVED

**Symptom:**
```
Error: could not find function "check.for.invalid.characters"
Failed to load 'R/INTERVENTIONS_main.R'
```

**Root Cause:**
`NULL.INTERVENTION$new()` was called at the top level of INTERVENTIONS_main.R (line 864). This executed during package loading, before jheem.core's namespace was fully resolved.

**Why This Happened:**
R sources files in order but imports aren't fully available until after all files are sourced. The top-level code tried to validate intervention code using `check.for.invalid.characters` from jheem.core, but jheem.core wasn't loaded yet.

**Solution:**
1. Removed top-level `NULL.INTERVENTION$new()` call
2. Added `.onLoad()` hook in R/zzz.R:
   ```r
   .onLoad <- function(libname, pkgname) {
       NULL.INTERVENTION$new()
   }
   ```
3. Made `get.null.intervention()` lazy (creates if doesn't exist)

**Status:** ✅ Resolved
**Priority:** N/A (fixed)
**Tech Debt:** Minor (see below)
**Pattern:** This is the **standard R approach** for package initialization

---

## Current Tech Debt

### TD-1: jheem.core NAMESPACE Manually Modified

**Issue:**
```r
# Generated by roxygen2: do not edit by hand
# Manually modified to export all functions
exportPattern(".")
```

We overrode roxygen2's NAMESPACE generation to export all functions using `exportPattern(".")`.

**Why:**
Many helper functions in ONTOLOGY, HELPERS, VERSIONS lack `@export` roxygen tags. Rather than add 100+ tags, we exported everything.

**Impact:**
- ⚠️ Exports internal functions (minor namespace pollution)
- ⚠️ NAMESPACE out of sync with roxygen2
- ✅ Everything works correctly

**Fix:**
Add `@export` tags to all public functions, remove `exportPattern(".")`, regenerate NAMESPACE with `devtools::document()`.

**Priority:** Low
**Effort:** ~2 hours
**When:** Phase 2 (after all packages extracted)

---

### TD-2: NULL.INTERVENTION Initialization Split

**Issue:**
NULL.INTERVENTION is initialized in two places:
1. `.onLoad()` in R/zzz.R - creates on package load
2. `get.null.intervention()` - creates lazily if missing

This is redundant (defense in depth) but slightly confusing.

**Why:**
We wanted to ensure NULL.INTERVENTION exists even if .onLoad somehow fails.

**Impact:**
- ⚠️ Slightly redundant code
- ✅ Defensive programming
- ✅ Works correctly

**Fix:**
Pick one approach:
- Option A: Keep .onLoad only, remove lazy creation
- Option B: Keep lazy creation only, remove .onLoad

**Priority:** Very Low
**Effort:** 15 minutes
**When:** Phase 2 or later

---

### TD-3: Existing Tests Not Run ⚠️ HIGH PRIORITY

**Issue:**
We've done smoke testing (package loads, basic functions work) but haven't run the existing jheem2 test suite.

**Risk:**
We may have broken downstream functionality without knowing it.

**Tests to Run:**
1. `source('R/production_tests/DATA_MANAGER_bulk_tests.R')`
2. `source('R/production_tests/ONTOLOGY_mapping_tests.R')`
3. Manual workflow test:
   ```r
   spec <- create.jheem.specification(...)
   engine <- create.jheem.engine(...)
   sim <- engine$run(...)
   ```

**Priority:** **HIGH**
**Effort:** 30 min to run, unknown to fix
**When:** **Next session (before continuing extraction)**

---

## Testing Status

### ✅ Completed

- [x] jheem.core builds independently
- [x] jheem.core installs to R library
- [x] jheem.core exports functions
- [x] jheem2 loads with devtools::load_all()
- [x] ontology() function works
- [x] check.for.invalid.characters() works
- [x] NUMBERS.LETTERS.DASH.PERIOD constant accessible

### ❌ Not Yet Tested

- [ ] Existing jheem2 test suite
- [ ] Create JHEEM.ENGINE
- [ ] Run simulation
- [ ] Create DATA.MANAGER
- [ ] Run calibration
- [ ] Create interventions
- [ ] Full workflow integration

**Next Session Priority:** Run existing tests BEFORE extracting next package.

---

## Decisions Made

### Decision 1: Use .onLoad() for Initialization

**Context:** NULL.INTERVENTION was created at top level, failed during loading.

**Options Considered:**
- A: Keep top-level, make jheem.core load earlier (can't control)
- B: Make everything lazy (slower, more complex)
- C: Use .onLoad() + lazy getter (chosen)

**Decision:** Use .onLoad() with lazy getter as backup

**Rationale:**
- Standard R package development pattern
- Guarantees initialization order
- Defensive programming with lazy creation

**Status:** Implemented, working

---

### Decision 2: Export All Functions from jheem.core

**Context:** Many functions lack @export tags, integration failed.

**Options Considered:**
- A: Add @export to all functions (tedious, proper)
- B: Use exportPattern(".") (quick, works)

**Decision:** Use exportPattern(".") for now

**Rationale:**
- Speed vs perfection tradeoff
- Can add proper exports later
- Everything works correctly
- Follows "make it work, make it right, make it fast" principle

**Status:** Implemented, flagged as tech debt

---

## Lessons Learned

### L-1: Top-Level Code is Dangerous

**Lesson:** Don't execute code at the top level of R files that depend on imports.

**Why:** Imports aren't fully resolved until after all files are sourced.

**Pattern:** Use .onLoad() or .onAttach() for initialization.

**Apply To:** Check for other top-level code in JHEEM, SPECIFICATION, etc.

---

### L-2: Build Artifacts Must Be Excluded

**Lesson:** Always gitignore .o and .so files.

**Why:** They cause conflicts when files are moved/renamed.

**Pattern:** Add to .gitignore early in refactoring.

**Status:** Done

---

### L-3: Test Early and Often

**Lesson:** We should have run tests IMMEDIATELY after integration.

**Why:** Easier to fix when fresh, before continuing to next package.

**Pattern:** Run tests after EVERY major change.

**Action:** Add "run tests" to checklist for each package extraction.

---

## Next Session Checklist

Before continuing to extract jheem.specification:

1. [ ] Run existing test suite
2. [ ] Fix any broken tests
3. [ ] Test full simulation workflow
4. [ ] Document any new issues found
5. [ ] Update baseline metrics
6. [ ] THEN proceed with jheem.specification extraction

If tests fail:
- [ ] Determine root cause
- [ ] Decide: fix now or rollback?
- [ ] Document issue here
- [ ] Re-test after fix
